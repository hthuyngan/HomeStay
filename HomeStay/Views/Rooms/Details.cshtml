@model HomeStay.Models.Room
@{
    var averageRating = ViewBag.AverageRating ?? 0;
    var totalReviews = ViewBag.TotalReviews ?? 0;
}

<main class="main">
    <!-- Page Title -->
    <div class="page-title light-background">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">Chi tiết phòng</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a href="/">Trang chủ</a></li>
                    <li class="current">Chi tiết phòng</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Room Details Section -->
    <section id="room-details" class="room-details section">
        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <!-- Room Header -->
            <div class="row align-items-center mb-5">
                <div class="col-lg-7" data-aos="fade-right" data-aos-delay="200">
                    <div class="room-header-image">
                        <img src="~/img/hotel/room-15.webp" alt="Deluxe Ocean View Suite" class="img-fluid rounded">
                        <div class="room-badge">
                            <span class="text-white">@Model.RoomType.TypeName</span>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5" data-aos="fade-left" data-aos-delay="300">
                    <div class="room-header-content">
                        <div class="room-rating mb-3">
                            <span class="rating-score">@averageRating.ToString("F1")</span>
                            <div class="stars">
                                        <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                            </div>
                            <span class="reviews-count">(@totalReviews đánh giá)</span>
                        </div>
                        <h1 class="room-title">@Model.RoomName</h1>
                        <p class="room-tagline">@Model.Description</p>
                        <div class="room-capacity mb-4">
                            <div class="capacity-item">
                                <i class="bi bi-people"></i>
                                <span>Tối đa @Model.Capacity khách</span>
                            </div>
                            <div class="capacity-item">
                                <i class="bi bi-grid"></i>
                                <span>@Model.Size</span>
                            </div>
                        </div>
                        <div class="room-price">
                            <span class="price-amount">@Model.Price VNĐ</span>
                            <span class="price-period">mỗi đêm</span>
                        </div>
                        <a href="/booking/@Model.Alias-@Model.RoomId" class="btn btn-book-now">Đặt ngay</a>
                    </div>
                </div>
            </div>

            <!-- Room Amenities -->
            @if (Model.RoomAmenities != null && Model.RoomAmenities.Any())
            {
                <div class="room-amenities mb-5" data-aos="fade-up" data-aos-delay="200">
                    <h3 class="section-subtitle mb-4">Tiện nghi phòng</h3>
                    <div class="row">
                        @foreach (var amenity in Model.RoomAmenities)
                        {
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="amenity-item">
                                    <i class="bi bi-check2-circle"></i>
                                    <span>@amenity.Amenity.AmenityName</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Reviews Section -->
            <div class="room-reviews mb-5" data-aos="fade-up" data-aos-delay="200">
                <h3 class="section-subtitle mb-4">Đánh giá từ khách hàng</h3>

                <!-- Rating Summary -->
                <div class="rating-summary mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center">
                            <div class="overall-rating">
                                <h2 class="rating-number">@averageRating.ToString("F1")</h2>
                                <div class="stars mb-2">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="bi bi-star-fill @(i <= averageRating ? "text-warning" : "text-muted")"></i>
                                    }
                                </div>
                                <p class="text-muted">Dựa trên @totalReviews đánh giá</p>
                            </div>
                        </div>
                        <div class="col-md-9">
                            @if (totalReviews > 0)
                            {
                                @for (int star = 5; star >= 1; star--)
                                {
                                    var starCount = Model.RoomsReviews.Count(r => r.Rating == star);
                                    var percentage = (starCount * 100.0) / totalReviews;
                                    <div class="rating-bar mb-2">
                                        <span class="star-label">@star <i class="bi bi-star-fill"></i></span>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" style="width: @percentage%"></div>
                                        </div>
                                        <span class="rating-count">@starCount</span>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>


                <!-- Add Review Form -->
                <div class="add-review-form mb-4">
                    <h5>Viết đánh giá của bạn</h5>
                    <form asp-action="AddReview" method="post">
                        <input type="hidden" name="roomId" value="@Model.RoomId" />

                        <div class="mb-3">
                            <label class="form-label">Đánh giá của bạn</label>
                            <div class="star-rating">
                                @for (int i = 5; i >= 1; i--)
                                {
                                    <input type="radio" name="rating" value="@i" id="star@i" required />
                                    <label for="star@i"><i class="bi bi-star-fill"></i></label>
                                }
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="comment" class="form-label">Nhận xét</label>
                            <textarea class="form-control" id="comment" name="comment" rows="4"
                                      placeholder="Chia sẻ trải nghiệm của bạn..." required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
                    </form>
                </div>

                <!-- Reviews List -->
                <div class="reviews-list">
                    @if (Model.RoomsReviews != null && Model.RoomsReviews.Any())
                    {
                        @foreach (var review in Model.RoomsReviews.OrderByDescending(r => r.CreatedAt))
                        {
                            <div class="review-item mb-4">
                                <div class="review-header d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="reviewer-name mb-1">@review.User.Username</h6>
                                        <div class="review-stars mb-2">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="bi bi-star-fill @(i <= review.Rating ? "text-warning" : "text-muted")"></i>
                                            }
                                        </div>
                                    </div>
                                    <span class="review-date text-muted">
                                        @review.CreatedAt?.ToString("dd/MM/yyyy")
                                    </span>
                                </div>
                                <div class="review-content">
                                    <p>@review.Comment</p>
                                </div>
                            </div>
                            <hr />
                        }
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Chưa có đánh giá nào cho phòng này. Hãy là người đầu tiên đánh giá!
                        </div>
                    }
                </div>
            </div>

            <!-- Booking CTA -->
            <div class="booking-cta" data-aos="fade-up" data-aos-delay="200">
                <div class="booking-card">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h4>Sẵn sàng đặt phòng?</h4>
                            <p>Trải nghiệm sự thoải mái tại @Model.RoomName. Đặt ngay để tạo những kỷ niệm khó quên.</p>
                        </div>
                        <div class="col-lg-4 text-center text-lg-end">
                            <div class="price-display">
                                <span class="price">@Model.Price VNĐ</span>
                                <span class="period">mỗi đêm</span>
                            </div>
                            <a href="/booking/@Model.Alias-@Model.RoomId" class="btn btn-primary btn-lg">Kiểm tra phòng trống</a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>
</main>

<style>
    /* Review Styles */
    .rating-summary {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
    }

    .overall-rating .rating-number {
        font-size: 3rem;
        font-weight: bold;
        color: #ffc107;
    }

    .rating-bar {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .star-label {
        min-width: 50px;
        font-size: 0.9rem;
    }

    .rating-bar .progress {
        flex: 1;
        height: 8px;
    }

    .rating-count {
        min-width: 40px;
        text-align: right;
        color: #6c757d;
    }

    /* Star Rating Input */
    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 5px;
    }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            cursor: pointer;
            font-size: 2rem;
            color: #ddd;
            transition: color 0.2s;
        }

            .star-rating input:checked ~ label,
            .star-rating label:hover,
            .star-rating label:hover ~ label {
                color: #ffc107;
            }

    /* Review Item */
    .review-item {
        padding: 20px;
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
    }

    .reviewer-name {
        font-weight: 600;
        color: #333;
    }

    .review-stars i {
        font-size: 0.9rem;
    }

    .review-date {
        font-size: 0.85rem;
    }

    .add-review-form {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 10px;
    }

    .amenity-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .amenity-item i {
            color: #28a745;
            font-size: 1.2rem;
        }
</style>